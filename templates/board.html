<!DOCTYPE html>
<html>
<head>
<title>Swimmer and Time Standards ScoreCard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="stylesheet" type= "text/css" href= "{{ url_for('static',filename='table.css') }}">
<style>
body {
    margin: 20px;
}
.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input { 
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
}

input:checked + .slider {
    background-color: #2196F3;
}

input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
    -webkit-transform: translateX(26px);
    -ms-transform: translateX(26px);
    transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}
</style>
</head>

<body>
<h3 id="banner">Swimmers vs Time Standards</h3>
<a href="/select" id="goback" class="btn btn-primary btn-sm">Back to Selection</a> &nbsp;&nbsp;
<button type="button" class="btn btn-secondary btn-sm" onclick="copy_url()">Share</button>
&nbsp;&nbsp;<a id="url_text" href=""></a>
<br/><br/>
<input type="text" id="event_filter" onkeyup="apply_filter()" placeholder="Search for Event Name.." size="30">
<br/><br/>
<label class="switch">
    <input id="headroom" type="checkbox" onclick="toggle_headroom_column()"/>
    <span class="slider round"></span>
</label>&nbsp;&nbsp;Headroom
  
<table border="1" id="swimmers">
  <thead>
      <tr>
          <th></th>
          {% for i in range(colnames | length): %}
          <th>
            {% if i == 0 %}
                {% if colnames[i].startswith('JO')%}
                    <a href="https://www.pacswim.org/userfiles/cms/documents/809/agc-time-std.-scy-2023-2024-rev-9.18.23.pdf">{{colnames[i]}}</a>
                {% elif colnames[i].startswith('FW') %}
                    <a href="https://www.pacswim.org/userfiles/cms/documents/859/fw-time-std.---spring-2024-rev-8.25.23.pdf"> {{colnames[i]}} </a>
                {% elif colnames[i].endswith('@nt') %}    
                    456
                {% else %}
                    123
                {% endif %}
            {% elif colnames[i].endswith('@nt') %} 
                ðŸ“¶
            {% else %}
                <a href="https://swimstandards.com/swimmer/{{colnames[i]}}">
                {{ colnames[i] }}</a>
            {% endif %}
          </th>
          {% endfor %}
      </tr>
  </thead>
  <tbody>
      {% for i in range(records | length): %}
      <tr>
          <td> {{ rownames[i] }} </td>
          {% for j in range(colnames | length): %}
            {% if j == 0 %}
                <td class="standards"> {{ records[i][colnames[j]] }}  </td>
            {% elif j > 0 and compare_time(records[i][colnames[j]], records[i][colnames[0]]) %}
                <td class="qualified"> {{ records[i][colnames[j]] }} </td>
            {% else %}   
                <td> {{ records[i][colnames[j]] }}  </td>
            {% endif %}            
          {% endfor %}
      </tr>
      {% endfor %}
  </tbody>
</table>

<script>
function apply_filter() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("event_filter");
    filter = input.value.toUpperCase();
    table = document.getElementById("swimmers");
    tr = table.getElementsByTagName("tr");
    for (i = 0; i < tr.length; i++) {
    td = tr[i].getElementsByTagName("td")[0];
    if (td) {
        txtValue = td.textContent || td.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
        } else {
        tr[i].style.display = "none";
        }
    }       
    }
}
function copy_url() {
    var input, filter, table, tr, td, i, txtValue;
    table = document.getElementById("swimmers");
    tr = table.getElementsByTagName("tr");    
    th_list = tr[0].getElementsByTagName("th");
    console.log(th_list.length);
    if (th_list.length <= 1) {
        return;
    } 
    var url = "http://qualihub.net/board?"
    url += "ts="+th_list[1].innerText;
    if (th_list.length > 2) {
        url += "&id=";
    }
    const buttonChecked = document.querySelector('#headroom').checked;
    var format = "{{format}}";
    var step = (format == "records+nationaltime") ? 2 : 1;
    for (i = 2; i < th_list.length; ) {
      url += (th_list[i].innerText);
      if (buttonChecked) {
        if ( i < th_list.length - 1 - step) {
          url += ",";
        }
        i += 1 + step;
      } else {
        if ( i < th_list.length  - step) {
          url += ",";
        }
        i += step;
      }
    }

    // console.log(url);
    document.getElementById("url_text").innerHTML = url;
    document.getElementById("url_text").href = url;
    // Copy the text inside the text field
    navigator.clipboard.writeText(url).then(() => {
        alert("successfully copied to clipboard");
      })
      .catch(() => {
        alert("copy to clipboard failed");
      });
}

function toggle_headroom_column() {
    const buttonChecked = document.querySelector('#headroom').checked;
    var format = "{{format}}";
    var step = (format == "records+nationaltime") ? 2 : 1;
    if (buttonChecked) {
        document.querySelectorAll('#swimmers tr').forEach((row, i) => {
            const cols = row.children.length;
            for (let j = cols - step ; j > 1; j-=step) {
                const span = document.createElement("span");
                if ( i == 0) {
                    span.innerHTML = "Î”";
                    // span.innerHTML = "ðŸ”º";
                }
                else {
                    span.innerHTML = headroom(row.children[1].innerHTML.trim(), row.children[j].innerHTML.trim());
                }
                const cell = document.createElement(i ? "td" : "th")
                cell.appendChild(span)
                cell.style.textAlign="center";
                cell.classList.add("time-delta")
                row.insertBefore(cell, row.children[j+1]);
            }
        });
    } else {
        document.querySelectorAll('#swimmers tr').forEach((row, i) => {
            const cols = row.children.length;
            for (let j = cols - 1 ; j >= 0; j--) {
                if (row.children[j].classList.contains("time-delta")) {
                    row.removeChild(row.children[j])
                }
            }
        });
    }
}

function toSeconds(timestr) {
    seconds = 0;
    tokens = timestr.split('.');
    if (tokens.length == 2) {
        seconds += parseFloat(tokens[1]) / 100;
    }
    parts = tokens[0].split(':')
    if (parts.length == 2) {
        seconds += parseInt(parts[0]) * 60 + parseInt(parts[1])
    } else {
        seconds += parseInt(parts[0])
    }
    return seconds;
}

function toTimeStr(seconds) {
    minutes = 0;
    while (seconds >=60) {
        seconds -= 60;
        minutes ++;
    }
    timestr = "";
    if (minutes > 0) {
        timestr += minutes + ":";
    }
    if (Math.floor(seconds) >= 10) {
        timestr += Math.floor(seconds);
    } else {
        timestr += "0" + Math.floor(seconds);
    }
    seconds_part = Math.round(seconds * 100 % 100);
    console.log("minutes="+minutes)
    console.log("seconds="+seconds)
    console.log("seconds_part="+seconds_part)
    timestr += "." + (seconds_part >= 10 ? seconds_part : "0" + seconds_part);
    return timestr;
}

function headroom(timestr1, timestr2){
    if (timestr1 == "" || timestr2 == "") return "";
    sec1 = toSeconds(timestr1);
    sec2 = toSeconds(timestr2);
    if (sec2 < sec1) {
        return "-"+headroom(timestr2, timestr1);
    }
    return toTimeStr(sec2-sec1);
}
</script>

</body>
</html>